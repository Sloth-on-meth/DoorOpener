name: CI
permissions:
  contents: read

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  tests:
    name: Tests (pytest + coverage)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Prepare test options.json
        run: |
          python3 -c "
          import json
          json.dump({
            'ha_url': 'http://localhost:8123',
            'ha_token': 'dummy_test_token',
            'entity_id': 'switch.test_door',
            'battery_entity': 'sensor.test_door_battery',
            'port': 6532,
            'test_mode': True,
            'admin_password': 'testpass',
            'max_attempts': 5,
            'block_time_minutes': 5,
            'max_global_attempts_per_hour': 50,
            'session_max_attempts': 3,
            'secret_key': 'ci-test-secret-key',
            'session_cookie_secure': False,
            'ca_bundle': ''
          }, open('options.json', 'w'))
          "

      - name: Run tests with coverage
        run: >
          pytest --maxfail=3 --disable-warnings -q
          --cov=./ --cov-report=term-missing
          --cov-fail-under=75

  lint:
    name: Lint (ruff)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff
        run: ruff check .

  security:
    name: Security (bandit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install bandit
        run: pip install bandit

      - name: Security scan
        run: bandit -q -r . -x tests || true

  docker:
    name: Docker build smoke test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t dooropener:ci .
